#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
STEP3_compile_results_dual_wl.py

Results compilation script for dual-wavelength augmented simulations. This
module collects individual pickle files generated by batch jobs, combines them
into a single dictionary of xarray DataArrays organized by parameter dimensions,
and saves the compiled results for subsequent visualization and analysis.

Usage
-----
Edit the CONFIG section (ROOT_DIR, TASK, alpha_meas_list, etc.) then run::

    python STEP3_compile_results_dual_wl.py

Inputs
------
- Individual pickle files from dual_wl_metrics_batch_aug.py located in
  <ROOT_DIR>/derivatives/cedalion/augmented_data/batch_results/
  with filename pattern: COMPILED_METRIC_RESULTS_{BLOB_SIGMA}mm_scale-{SCALE_FACTOR}_sb-{sigma_brain}_ss-{sigma_scalp}_am-{alpha_meas}_as-{alpha_spatial}_{GLM_METHOD}_dual_wl.pkl
  containing reconstruction metrics for each parameter combination.

Configurables (defaults shown)
-----------------------------
Data Storage Parameters:
- ROOT_DIR (str): '/projectnb/nphfnirs/s/datasets/BSMW_Laura_Miray_2025/BS_bids'
    - Root directory containing batch results.
- EXCLUDED (list[str]): ['sub-577']
    - Subject IDs to skip during processing.

Augmentation Parameters (must match batch scripts):
- BLOB_SIGMA (float): 15
    - Standard deviation of Gaussian activation blob in mm.
- TASK (str): 'RS'
    - Task identifier matching the augmented dataset.
- SCALE_FACTOR (float): 0.02
    - Amplitude of synthetic activation.
- NOISE_MODEL (str): 'ols'
    - GLM method used in variance estimation (ols or ar_irls).
- VERTEX_LIST (list[int]): [10089, 10453, 14673, 11323, 13685, 11702, 8337]
    - List of seed vertex indices used in simulations.

Parameter Grid (must match batch submission):
- alpha_meas_list (list[float]): [10 ** i for i in range(-6, 6)]
    - Measurement regularization values tested (0.1, 1, 10, 100).
- alpha_spatial_list (list[float]): [1e-3, 1e-2]
    - Spatial regularization values tested.
- sigma_brain_list (list[int]): [0, 1, 3, 5]
    - Brain spatial basis widths tested (mm).
- sigma_scalp_list (list[int]): [0, 1, 5, 10, 20]
    - Scalp spatial basis widths tested (mm).

Compilation Logic:
- Skips invalid combinations where sigma_brain=0 and sigma_scalp!=0, or vice versa.
- Collects metrics from all parameter combinations into xarray DataArrays.

Outputs
-------
- Compiled results saved as pickle file to
  <ROOT_DIR>/derivatives/cedalion/augmented_data/
  with filename: COMPILED_METRIC_RESULTS_blob-{BLOB_SIGMA}mm_scale-{SCALE_FACTOR}_{GLM_METHOD}_dual_wl.pkl
  containing dictionary with xarray DataArrays (dimensions: [alpha_meas, alpha_spatial, 
  sigma_brain, sigma_scalp, vertex]) for the following metrics:
  - FWHM_HbO_direct/indirect: Full width at half maximum
  - CNR_HbO_direct/indirect: Contrast-to-noise ratio
  - crosstalk_brainVscalp_HbO_direct/indirect: Brain-scalp crosstalk
  - localization_error_HbO_direct/indirect: Distance to true peak
  - contrast_ratio_HbO_direct/indirect: Reconstructed/expected contrast
  - crosstalk_HbOVHbR_direct/indirect: HbO-to-HbR crosstalk
  - crosstalk_HbRVHbO_direct/indirect: HbR-to-HbO crosstalk

Dependencies
------------
- xarray, numpy, pickle, os

Author: Laura Carlton
"""
#%%
import pickle 
import os 
import xarray as xr
import numpy as np 

ROOT_DIR = os.path.join('/projectnb', 'nphfnirs', 's', 'datasets', 'BSMW_Laura_Miray_2025', 'BS_bids')
BLOB_SIGMA = 15
NOISE_MODEL = 'ols'
TASK = 'RS'
VERTEX_LIST = [10089, 10453, 14673, 11323, 13685, 11702, 8337]
SCALE_FACTOR = 0.02
EXCLUDED = ['sub-577']

alpha_meas_list = [10 ** i for i in range(-1, 3)]
alpha_spatial_list = [1e-3, 1e-2]
sigma_brain_list = [0, 1, 3, 5]
sigma_scalp_list = [0, 1, 5, 10, 20]

SAVE_DIR = os.path.join(ROOT_DIR, 'derivatives', 'cedalion', 'augmented_data')
BATCH_DIR = os.path.join(SAVE_DIR, 'batch_results')

dirs = os.listdir(ROOT_DIR)
subject_list = [d for d in dirs if 'sub' in d and d not in EXCLUDED]

FWHM_HbO_direct = xr.DataArray(np.zeros([len(alpha_meas_list), len(alpha_spatial_list), len(sigma_brain_list), len(sigma_scalp_list), len(VERTEX_LIST)]),
                      dims = ['alpha_meas', 'alpha_spatial', 'sigma_brain', 'sigma_scalp', 'vertex'],
                      coords = {'alpha_meas': alpha_meas_list,
                                'alpha_spatial': alpha_spatial_list,
                                'sigma_brain': sigma_brain_list,
                                'sigma_scalp': sigma_scalp_list,
                                'vertex': VERTEX_LIST,
                                 })

CNR_HbO_direct = FWHM_HbO_direct.copy()
CNR_HbO_indirect = FWHM_HbO_direct.copy()
FWHM_HbO_indirect = FWHM_HbO_direct.copy()
crosstalk_brainVscalp_direct = FWHM_HbO_direct.copy()
LE_HbO_direct = FWHM_HbO_direct.copy()
crosstalk_brainVscalp_indirect = FWHM_HbO_direct.copy()
LE_HbO_indirect = FWHM_HbO_direct.copy()
contrast_ratio_HbO_direct = FWHM_HbO_direct.copy()
contrast_ratio_HbO_indirect = FWHM_HbO_direct.copy()
crosstalk_HbOVHbR_direct = FWHM_HbO_direct.copy()
crosstalk_HbRVHbO_direct = FWHM_HbO_direct.copy()
crosstalk_HbOVHbR_indirect = FWHM_HbO_direct.copy()
crosstalk_HbRVHbO_indirect = FWHM_HbO_direct.copy()

for sigma_brain in sigma_brain_list: 
    
    for sigma_scalp in sigma_scalp_list:
        
        if sigma_brain == 0 and sigma_scalp != 0:
            continue
        elif sigma_brain != 0 and sigma_scalp == 0:
            continue
        
        for alpha_meas in alpha_meas_list:
            
            for alpha_spatial in alpha_spatial_list:
                
                with open(os.path.join(BATCH_DIR, f'COMPILED_METRIC_RESULTS_task-{TASK}_blob-{BLOB_SIGMA}mm_scale-{SCALE_FACTOR}_sb-{float(sigma_brain)}_ss-{float(sigma_scalp)}_am-{float(alpha_meas)}_as-{float(alpha_spatial)}_{NOISE_MODEL}_dual_wl.pkl'), 'rb') as f:
                    RESULTS = pickle.load(f)
                
                FWHM_HbO_direct.loc[alpha_meas, alpha_spatial, sigma_brain, sigma_scalp, :] = RESULTS['FWHM_HbO_direct'].squeeze()
                FWHM_HbO_indirect.loc[alpha_meas, alpha_spatial, sigma_brain, sigma_scalp, :] = RESULTS['FWHM_HbO_indirect'].squeeze()
                CNR_HbO_direct.loc[alpha_meas, alpha_spatial, sigma_brain, sigma_scalp, :] = RESULTS['CNR_HbO_direct'].squeeze()
                CNR_HbO_indirect.loc[alpha_meas, alpha_spatial, sigma_brain, sigma_scalp, :] = RESULTS['CNR_HbO_indirect'].squeeze()
                crosstalk_brainVscalp_direct.loc[alpha_meas, alpha_spatial, sigma_brain, sigma_scalp, :] = RESULTS['crosstalk_brainVscalp_HbO_direct'].squeeze()
                crosstalk_brainVscalp_indirect.loc[alpha_meas, alpha_spatial, sigma_brain, sigma_scalp, :] = RESULTS['crosstalk_brainVscalp_HbO_indirect'].squeeze()
                LE_HbO_direct.loc[alpha_meas, alpha_spatial, sigma_brain, sigma_scalp, :] = RESULTS['localization_error_HbO_direct'].squeeze()
                LE_HbO_indirect.loc[alpha_meas, alpha_spatial, sigma_brain, sigma_scalp, :] = RESULTS['localization_error_HbO_indirect'].squeeze()
                crosstalk_HbOVHbR_direct.loc[alpha_meas, alpha_spatial, sigma_brain, sigma_scalp, :] = RESULTS['crosstalk_HbOVHbR_direct'].squeeze()
                crosstalk_HbRVHbO_direct.loc[alpha_meas, alpha_spatial, sigma_brain, sigma_scalp, :] = RESULTS['crosstalk_HbRVHbO_direct'].squeeze()
                crosstalk_HbOVHbR_indirect.loc[alpha_meas, alpha_spatial, sigma_brain, sigma_scalp, :] = RESULTS['crosstalk_HbOVHbR_indirect'].squeeze()
                crosstalk_HbRVHbO_indirect.loc[alpha_meas, alpha_spatial, sigma_brain, sigma_scalp, :] = RESULTS['crosstalk_HbRVHbO_indirect'].squeeze()
                contrast_ratio_HbO_indirect.loc[alpha_meas, alpha_spatial, sigma_brain, sigma_scalp, :] = RESULTS['contrast_ratio_HbO_indirect'].squeeze()
                contrast_ratio_HbO_direct.loc[alpha_meas, alpha_spatial, sigma_brain, sigma_scalp, :] = RESULTS['contrast_ratio_HbO_direct'].squeeze()


RESULTS = {
           'crosstalk_HbOVHbR_direct': crosstalk_HbOVHbR_direct,
           'crosstalk_HbRVHbO_direct':  crosstalk_HbRVHbO_direct,
           'crosstalk_HbOVHbR_indirect': crosstalk_HbOVHbR_indirect,
           'crosstalk_HbRVHbO_indirect': crosstalk_HbRVHbO_indirect,
           'CNR_HbO_direct': CNR_HbO_direct,
           'CNR_HbO_indirect': CNR_HbO_indirect,
           'FWHM_HbO_indirect': FWHM_HbO_indirect,
           'FWHM_HbO_direct': FWHM_HbO_direct,
           'localization_error_HbO_indirect': LE_HbO_indirect,
           'localization_error_HbO_direct': LE_HbO_direct,
           'crosstalk_brainVscalp_HbO_direct': crosstalk_brainVscalp_direct,
           'crosstalk_brainVscalp_HbO_indirect': crosstalk_brainVscalp_indirect,
            'contrast_ratio_HbO_direct': contrast_ratio_HbO_direct,
            'contrast_ratio_HbO_indirect': contrast_ratio_HbO_indirect,
           }


with open(os.path.join(SAVE_DIR, f'COMPILED_METRIC_RESULTS_task-{TASK}_blob-{BLOB_SIGMA}mm_scale-{SCALE_FACTOR}_{NOISE_MODEL}_dual_wl.pkl'), 'wb') as f:
     pickle.dump(RESULTS, f)



# %%
