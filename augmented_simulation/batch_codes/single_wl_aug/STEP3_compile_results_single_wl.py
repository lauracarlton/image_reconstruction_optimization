#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
STEP3_compile_results_single_wl.py

Results compilation script for single-wavelength augmented simulations. This
module collects individual pickle files generated by batch jobs, combines them
into a single dictionary of xarray DataArrays organized by parameter dimensions,
and saves the compiled results for subsequent visualization and analysis.

Usage
-----
Edit the CONFIG section (ROOT_DIR, TASK, alpha_meas_list, etc.) then run::

    python STEP3_compile_results_single_wl.py

Inputs
------
- Individual pickle files from single_wl_metrics_batch_aug.py located in
  <ROOT_DIR>/derivatives/cedalion/augmented_data/batch_results/
  with filename pattern: COMPILED_METRIC_RESULTS_task-{TASK}_blob-{BLOB_SIGMA}mm_scale-{SCALE_FACTOR}_sb-{sigma_brain}_ss-{sigma_scalp}_am-{alpha_meas}_as-{alpha_spatial}_{NOISE_MODEL}_single_wl.pkl
  containing reconstruction metrics for each parameter combination.

Configurables (defaults shown)
-----------------------------
Data Storage Parameters:
- ROOT_DIR (str): '/projectnb/nphfnirs/s/datasets/BSMW_Laura_Miray_2025/BS_bids'
    - Root directory containing batch results.
- EXCLUDED (list[str]): ['sub-577']
    - Subject IDs to skip during processing.

Augmentation Parameters (must match batch scripts):
- BLOB_SIGMA (float): 15
    - Standard deviation of Gaussian activation blob in mm.
- TASK (str): 'RS'
    - Task identifier matching the augmented dataset.
- SCALE_FACTOR (float): 0.02
    - Amplitude of synthetic activation.
- NOISE_MODEL (str): 'ols'
    - GLM method used in variance estimation (ols or ar_irls).
- VERTEX_LIST (list[int]): [10089, 10453, 14673, 11323, 13685, 11702, 8337]
    - List of seed vertex indices used in simulations.

Parameter Grid (must match batch submission):
- alpha_meas_list (list[float]): [10 ** i for i in range(-1, 3)]
    - Measurement regularization values tested (0.1, 1, 10, 100).
- alpha_spatial_list (list[float]): [1e-3, 1e-2]
    - Spatial regularization values tested.
- sigma_brain_list (list[int]): [0, 1, 3, 5]
    - Brain spatial basis widths tested (mm).
- sigma_scalp_list (list[int]): [0, 1, 5, 10, 20]
    - Scalp spatial basis widths tested (mm).

Compilation Logic:
- Skips invalid combinations where sigma_brain=0 and sigma_scalp!=0, or vice versa.
- Collects metrics from all parameter combinations into xarray DataArrays.

Outputs
-------
- Compiled results saved as pickle file to
  <ROOT_DIR>/derivatives/cedalion/augmented_data/
  with filename: COMPILED_METRIC_RESULTS_task-{TASK}_blob-{BLOB_SIGMA}mm_scale-{SCALE_FACTOR}_{NOISE_MODEL}_single_wl.pkl
  containing dictionary with xarray DataArrays (dimensions: [alpha_meas, alpha_spatial, 
  sigma_brain, sigma_scalp, vertex]) for the following metrics:
  - FWHM: Full width at half maximum of reconstructed activation
  - CNR: Contrast-to-noise ratio
  - crosstalk_brainVscalp: Brain vs scalp crosstalk measure
  - localization_error: Distance between true and reconstructed peak
  - perc_recon_brain: Percentage of signal reconstructed in brain
  - perc_recon_scalp: Percentage of signal reconstructed in scalp
  - contrast_ratio: Ratio of reconstructed to expected contrast

Dependencies
------------
- xarray, numpy, pickle, os

Author: Laura Carlton
"""

#%%
import pickle
import os
import xarray as xr
import numpy as np

ROOT_DIR = os.path.join('/projectnb', 'nphfnirs', 's', 'datasets', 'BSMW_Laura_Miray_2025', 'BS_bids')
BLOB_SIGMA = 15
NOISE_MODEL = 'ols'
TASK = 'RS'
VERTEX_LIST = [10089, 10453, 14673, 11323, 13685, 11702, 8337]
SCALE_FACTOR = 0.02

alpha_meas_list = [10 ** i for i in range(-1, 3)]
alpha_spatial_list = [1e-3, 1e-2]
sigma_brain_list = [0, 1] #, 3, 5]
sigma_scalp_list = [0, 5] #, 5, 10, 20]
EXCLUDED = ['sub-577']

SAVE_DIR = os.path.join(ROOT_DIR, 'derivatives', 'cedalion', 'augmented_data')
BATCH_DIR = os.path.join(SAVE_DIR, 'batch_results')

dirs = os.listdir(ROOT_DIR)
subject_list = [d for d in dirs if 'sub' in d and d not in EXCLUDED]

FWHM = xr.DataArray(np.zeros([len(alpha_meas_list), len(alpha_spatial_list), len(sigma_brain_list), len(sigma_scalp_list), len(VERTEX_LIST)]),
                      dims = ['alpha_meas', 'alpha_spatial', 'sigma_brain', 'sigma_scalp', 'vertex'],
                      coords = {'alpha_meas': alpha_meas_list,
                                'alpha_spatial': alpha_spatial_list,
                                'sigma_brain': sigma_brain_list,
                                'sigma_scalp': sigma_scalp_list,
                                'vertex': VERTEX_LIST,
                                 })

CNR = FWHM.copy()
crosstalk_brainVscalp = FWHM.copy()
localization_error = FWHM.copy()
perc_recon_brain = FWHM.copy()
perc_recon_scalp = FWHM.copy()
contrast_ratio = FWHM.copy()

for sigma_brain in sigma_brain_list:
    
    for sigma_scalp in sigma_scalp_list:
        
        if sigma_brain == 0 and sigma_scalp != 0:
            continue
        elif sigma_brain != 0 and sigma_scalp == 0:
            continue
        
        for alpha_meas in alpha_meas_list:
            
            for alpha_spatial in alpha_spatial_list:
                
                with open(os.path.join(BATCH_DIR, f'COMPILED_METRIC_RESULTS_task-{TASK}_blob-{BLOB_SIGMA}mm_scale-{SCALE_FACTOR}_sb-{float(sigma_brain)}_ss-{float(sigma_scalp)}_am-{float(alpha_meas)}_as-{float(alpha_spatial)}_{NOISE_MODEL}_single_wl.pkl'), 'rb') as f:
                    RESULTS = pickle.load(f)
                
                FWHM.loc[alpha_meas, alpha_spatial, sigma_brain, sigma_scalp, :] = RESULTS['FWHM'].squeeze()
                CNR.loc[alpha_meas, alpha_spatial, sigma_brain, sigma_scalp, :] = RESULTS['CNR'].squeeze()
                crosstalk_brainVscalp.loc[alpha_meas, alpha_spatial, sigma_brain, sigma_scalp, :] = RESULTS['crosstalk_brainVscalp'].squeeze()
                localization_error.loc[alpha_meas, alpha_spatial, sigma_brain, sigma_scalp, :] = RESULTS['localization_error'].squeeze()
                perc_recon_brain.loc[alpha_meas, alpha_spatial, sigma_brain, sigma_scalp, :] = RESULTS['perc_recon_brain'].squeeze()
                perc_recon_scalp.loc[alpha_meas, alpha_spatial, sigma_brain, sigma_scalp, :] = RESULTS['perc_recon_scalp'].squeeze()
                contrast_ratio.loc[alpha_meas, alpha_spatial, sigma_brain, sigma_scalp, :] = RESULTS['contrast_ratio'].squeeze()

RESULTS = {
           'CNR': CNR,
           'FWHM': FWHM,
           'localization_error': localization_error,
           'crosstalk_brainVscalp': crosstalk_brainVscalp,
           'perc_recon_brain': perc_recon_brain,
           'perc_recon_scalp': perc_recon_scalp,
            'contrast_ratio': contrast_ratio,
           }
                                    
with open(os.path.join(SAVE_DIR, f'COMPILED_METRIC_RESULTS_task-{TASK}_blob-{BLOB_SIGMA}mm_scale-{SCALE_FACTOR}_{NOISE_MODEL}_single_wl.pkl'), 'wb') as f:
     pickle.dump(RESULTS, f)



# %%
